#include "utils.h"
#include "term.h"

#define FONT_WIDTH  3
#define FONT_HEIGHT 5

/* 4bpp 3x5 pixel font (texture size: 192 x 10, 480 16bit words) */
const uint16_t font[(192 * 10) / 4] = {
    0x0000, 0x0101, 0x1011, 0x1110, 0x1010, 0x0100, 0x1100, 0x0000,
    0x0000, 0x0000, 0x0000, 0x1000, 0x0111, 0x1101, 0x0110, 0x1101,
    0x1111, 0x1111, 0x1010, 0x0011, 0x0000, 0x0000, 0x0000, 0x1110,
    0x0111, 0x1101, 0x1100, 0x1011, 0x1111, 0x1101, 0x1101, 0x0011,
    0x1011, 0x1001, 0x1110, 0x0100, 0x1111, 0x1111, 0x1111, 0x1111,
    0x0110, 0x1011, 0x1101, 0x1110, 0x0111, 0x0001, 0x1011, 0x0000,
    0x0000, 0x0101, 0x1111, 0x0011, 0x0110, 0x0101, 0x0010, 0x0101,
    0x0101, 0x0000, 0x0000, 0x1000, 0x1101, 0x0001, 0x1001, 0x1101,
    0x0100, 0x1000, 0x1101, 0x1010, 0x0100, 0x1010, 0x1011, 0x1000,
    0x1101, 0x0110, 0x0011, 0x1101, 0x0100, 0x0010, 0x0101, 0x0001,
    0x1011, 0x1001, 0x0111, 0x1011, 0x1101, 0x0110, 0x0011, 0x1010,
    0x0110, 0x1011, 0x1101, 0x0010, 0x0011, 0x0001, 0x0110, 0x0001,
    0x0000, 0x0001, 0x1010, 0x0010, 0x1001, 0x0001, 0x0011, 0x1011,
    0x1110, 0x1000, 0x0011, 0x0100, 0x0101, 0x1001, 0x0110, 0x1111,
    0x1111, 0x0101, 0x1010, 0x0011, 0x0000, 0x0001, 0x0000, 0x1101,
    0x1100, 0x1111, 0x0010, 0x1101, 0x1101, 0x1010, 0x0111, 0x0001,
    0x0111, 0x1001, 0x0110, 0x1011, 0x1111, 0x1110, 0x1111, 0x1010,
    0x0110, 0x1011, 0x0010, 0x1001, 0x0010, 0x0010, 0x0010, 0x0000,
    0x0000, 0x0000, 0x1110, 0x1110, 0x1100, 0x0000, 0x0010, 0x0101,
    0x0101, 0x0010, 0x0000, 0x0010, 0x0101, 0x0101, 0x1000, 0x0100,
    0x0110, 0x0011, 0x0101, 0x1010, 0x0100, 0x1010, 0x1011, 0x0000,
    0x1111, 0x0110, 0x0011, 0x1101, 0x0100, 0x1010, 0x0101, 0x0101,
    0x1011, 0x1001, 0x0110, 0x1011, 0x1001, 0x1111, 0x1000, 0x1010,
    0x0110, 0x1111, 0x0101, 0x0101, 0x0010, 0x0100, 0x0010, 0x0000,
    0x0000, 0x0001, 0x1010, 0x1011, 0x1010, 0x0001, 0x1100, 0x0000,
    0x0000, 0x0001, 0x1000, 0x0010, 0x1111, 0x1111, 0x0111, 0x1100,
    0x1111, 0x0011, 0x1010, 0x0011, 0x0010, 0x0000, 0x0000, 0x0100,
    0x1111, 0x1010, 0x1101, 0x1011, 0x0111, 0x0100, 0x1101, 0x1111,
    0x1011, 0x1111, 0x0110, 0x0101, 0x0001, 0x0110, 0x1111, 0x1010,
    0x1011, 0x1010, 0x0101, 0x1101, 0x0111, 0x0100, 0x0011, 0x1110,
    0x0001, 0x0100, 0x0000, 0x0100, 0x1000, 0x0001, 0x0001, 0x0000,
    0x0011, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
    0x0000, 0x0000, 0x0000, 0x0000, 0x1100, 0x1010, 0x0001, 0x0000,
    0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
    0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
    0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
    0x0010, 0x0101, 0x1100, 0x0100, 0x1001, 0x0100, 0x0001, 0x0001,
    0x0010, 0x1010, 0x1111, 0x0100, 0x0011, 0x0111, 0x0100, 0x1010,
    0x0110, 0x1011, 0x1101, 0x1110, 0x0101, 0x0010, 0x0001, 0x0001,
    0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
    0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
    0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
    0x1000, 0x1110, 0x0010, 0x1110, 0x1110, 0x1011, 0x0011, 0x0000,
    0x1011, 0x1010, 0x0111, 0x1011, 0x1101, 0x1110, 0x0010, 0x1111,
    0x0110, 0x1011, 0x1010, 0x1010, 0x0111, 0x0010, 0x1111, 0x0001,
    0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
    0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
    0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
    0x1000, 0x0110, 0x0011, 0x1101, 0x1001, 0x1100, 0x0101, 0x0001,
    0x0111, 0x1010, 0x0110, 0x1011, 0x0011, 0x0111, 0x0100, 0x1010,
    0x0110, 0x1111, 0x0010, 0x1101, 0x0100, 0x0010, 0x0101, 0x0000,
    0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
    0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
    0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
    0x0000, 0x1111, 0x1100, 0x0110, 0x1011, 0x0010, 0x0101, 0x1001,
    0x1010, 0x1110, 0x0110, 0x0101, 0x0001, 0x0110, 0x0010, 0x1110,
    0x1011, 0x1110, 0x1101, 0x1101, 0x1101, 0x1010, 0x0001, 0x0000,
    0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
    0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
    0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
};

/* Macro to convert 888 RGB into 555 BGR */
#define RGB(_r, _g, _b) ((_r >> 3) |         \
                         ((_g >> 3) << 5) |  \
                         ((_b >> 3) << 10))

/* 2 x 16 texture containing 2bit CLUTs for each of the 16 ANSI
   colors. The first entry (background color) is always fully
   transparent. */
const uint16_t clut[] = {
    /* 0x8000, 0xffff, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, */
    /* 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, */

    /* Black */
    0x0000, RGB(0, 0, 0),
    /* Red */
    0x0000, RGB(170, 0, 0),
    /* Green */
    0x0000, RGB(0, 170, 0),
    /* Yellow */
    0x0000, RGB(170, 85, 0),
    /* Blue */
    0x0000, RGB(0, 0, 170),
    /* Magenta */
    0x0000, RGB(170, 0, 170),
    /* Cyan */
    0x0000, RGB(0, 170, 170),
    /* White */
    0x0000, RGB(170, 170, 170),

    /* Bright black */
    0x0000, RGB(85, 85, 85),
    /* Bright Red */
    0x0000, RGB(255, 85, 85),
    /* Bright Green */
    0x0000, RGB(85, 255, 85),
    /* Bright Yellow */
    0x0000, RGB(255, 255, 85),
    /* Bright Blue */
    0x0000, RGB(85, 85, 255),
    /* Bright Magenta */
    0x0000, RGB(255, 85, 255),
    /* Bright Cyan */
    0x0000, RGB(85, 255, 255),
    /* Bright White */
    0x0000, RGB(255, 255, 255),
};

static void term_gpu_init(enum gpu_xres xres,
                          enum gpu_vmode vmode,
                          enum gpu_interlacing interlacing,
                          uint16_t width,
                          uint16_t height) {
    gpu_reset();

    gpu_set_video_mode(vmode, xres, interlacing);


    gpu_upload_texture(960, 0,
                       48, 10,
                       font);

    gpu_upload_texture(960, 0x20,
                       2, 16,
                       clut);

    gpu_clear_cache();

    gpu_set_draw_area(0, 0, width, height);

    gpu_set_draw_offset(0, 0);

    gpu_display_enable(true);

    gpu_set_texpage(960 / 64, 0,
                    GPU_TRANSP_HALF_SRC_PLUS_HALF_DST,
                    GPU_TEX_4BPP,
                    GPU_DITHER_DISABLED,
                    GPU_DRAW_TO_DISPLAY_AREA);
}

int term_init(enum gpu_xres xres,
               enum gpu_vmode vmode,
               enum gpu_interlacing interlacing,
               unsigned long backbuffer_lines) {

    unsigned i = 0;
    const char *msg = "HELLO, WORLD! Emulation sure is fun.";
    unsigned w = 0;
    unsigned h = 240;

    static const unsigned term_width[] = {
        [GPU_XRES_256] = 256,
        [GPU_XRES_320] = 320,
        [GPU_XRES_368] = 368,
        [GPU_XRES_512] = 512,
        [GPU_XRES_640] = 640,
    };

    if (interlacing == GPU_INTERLACING_ENABLED) {
        h *= 2;
    }

    if (xres > ARRAY_SIZE(term_width)) {
        bios_printf("%s: unknown xres: %d\n", __func__, xres);
        return -1;
    }

    w = term_width[xres];

    term_gpu_init(xres, vmode, interlacing, w, h);

    gpu_draw_rect_monochrome_opaque(0, 0,
                                    256, 256,
                                    0, 0, 0);

    /* gpu_draw_rect_raw_texture_opaque(0, 0, */
    /*                                  192, 10, */
    /*                                  0, 0, */
    /*                                  960 / 16, 0x27); */

    for (i = 0; msg[i]; i++) {
        char c = msg[i] - ' ';

        unsigned tex_x = (c % 64) * 3;
        unsigned tex_y = (c / 64) * 5;


        gpu_draw_rect_raw_texture_opaque(i * 4, 20,
                                         3, 5,
                                         tex_x, tex_y,
                                         960 / 16, 0x21 + (i % 5));
    }

    return 0;
}
