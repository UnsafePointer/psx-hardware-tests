OBJ = start.o main.o lcd.o

# File name in the memory card. The only important part is the 'P' in
# 7th position since it denotes a pocketstation executable.
FILE_NAME = BISCPSP-LOADER

# Directory added to the path for rustc to find arm-none-eabi-gcc and
# friends
XCC := /opt/pksx-tools/bin/arm-none-eabi-

# Tool used to format the memory card image
# https://github.com/simias/psx-mctool
PSX_MCTOOL := $(HOME)/bin/psx-mctool

CC := $(XCC)gcc
LD := $(XCC)ld
AR := $(CROSS)ar
OBJCPY := $(XCC)objcopy
SIZE := $(XCC)size

CFLAGS := -O2 -MMD -Wall -march=armv4t -mcpu=arm7tdmi -msoft-float -nostdlib
LDFLAGS := --gc-sections --fatal-warnings

DEP = $(OBJ:%.o=%.d)

.PHONY: all
all: loader.mcr

loader.mcr: loader.bin
	$(PSX_MCTOOL) format $@
	$(PSX_MCTOOL) load-raw-file $@ $^ "$(FILE_NAME)"
	$(PSX_MCTOOL) list-files $@

loader.bin: loader.elf
	$(SIZE) $^
	$(OBJCPY) -O binary $^ $@

loader.elf: pocketstation.ld loader.a
	$(LD) $(LDFLAGS) -o $@ -T $^

loader.a: $(OBJ)
	$(AR) rcs $@ $^

.PHONY: clean
clean:
	rm -rf $(OBJ) $(DEP) loader.elf loader.bin loader.mcr loader.a

# Header dependencies, generated by -MMD
-include $(DEP)
