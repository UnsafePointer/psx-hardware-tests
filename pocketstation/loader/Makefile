OBJ = start.o main.o lcd.o irq.o clock.o

# File name in the memory card. The only important part is the 'P' in
# 7th position since it denotes a pocketstation executable.
FILE_NAME := BISCPSP-LOADER

# Directory added to the path for rustc to find arm-none-eabi-gcc and
# friends
XCC := /opt/pksx-tools/bin/arm-none-eabi-

# Tool used to format the memory card image
# https://github.com/simias/psx-mctool
PSX_MCTOOL := $(HOME)/bin/psx-mctool

CC := $(XCC)gcc
LD := $(XCC)ld
AR := $(CROSS)ar
OBJCPY := $(XCC)objcopy
SIZE := $(XCC)size

# Change -marm to -mthumb to generate Thumb-1 machine code
CFLAGS := -O2 -MMD -Wall -Wextra -march=armv4t -mcpu=arm7tdmi -msoft-float \
          -nostdlib -mthumb-interwork -marm -ffunction-sections -fdata-sections
LDFLAGS := --gc-sections --fatal-warnings

DEP = $(OBJ:%.o=%.d)

.PHONY: all
all: loader.xplorer

loader.xplorer: loader.mcr
	$(PSX_MCTOOL) save-xplorer-file $^ 1 $@

loader.mcr: loader.bin
	$(PSX_MCTOOL) format $@
	$(PSX_MCTOOL) load-raw-file $@ $^ $(FILE_NAME)

loader.bin: loader.elf
	$(SIZE) $^
	$(OBJCPY) -O binary $^ $@

loader.elf: pocketstation.ld loader.a
	$(LD) $(LDFLAGS) -o $@ -T $^

loader.a: $(OBJ)
	$(AR) rcs $@ $^

.PHONY: clean
clean:
	rm -f $(OBJ) $(DEP) 
	rm -f loader.elf loader.bin loader.mcr loader.a loader.xplorer

# Header dependencies, generated by -MMD
-include $(DEP)
