#include "mdec.h"
#include "bios.h"

/* Mega Man X4 quant table */
static const uint8_t quant_table[128] = {
  0x02, 0x10, 0x10, 0x13, 0x10, 0x13, 0x16, 0x16,
  0x16, 0x16, 0x16, 0x16, 0x1a, 0x18, 0x1a, 0x1b,
  0x1b, 0x1b, 0x1a, 0x1a, 0x1a, 0x1a, 0x1b, 0x1b,
  0x1b, 0x1d, 0x1d, 0x1d, 0x22, 0x22, 0x22, 0x1d,
  0x1d, 0x1d, 0x1b, 0x1b, 0x1d, 0x1d, 0x20, 0x20,
  0x22, 0x22, 0x25, 0x26, 0x25, 0x23, 0x23, 0x22,
  0x23, 0x26, 0x26, 0x28, 0x28, 0x28, 0x30, 0x30,
  0x2e, 0x2e, 0x38, 0x38, 0x3a, 0x45, 0x45, 0x53,
  0x02, 0x10, 0x10, 0x13, 0x10, 0x13, 0x16, 0x16,
  0x16, 0x16, 0x16, 0x16, 0x1a, 0x18, 0x1a, 0x1b,
  0x1b, 0x1b, 0x1a, 0x1a, 0x1a, 0x1a, 0x1b, 0x1b,
  0x1b, 0x1d, 0x1d, 0x1d, 0x22, 0x22, 0x22, 0x1d,
  0x1d, 0x1d, 0x1b, 0x1b, 0x1d, 0x1d, 0x20, 0x20,
  0x22, 0x22, 0x25, 0x26, 0x25, 0x23, 0x23, 0x22,
  0x23, 0x26, 0x26, 0x28, 0x28, 0x28, 0x30, 0x30,
  0x2e, 0x2e, 0x38, 0x38, 0x3a, 0x45, 0x45, 0x53,
};

/* Standard IDCT table */
static const int16_t idct_table[64] = {
  23170,  23170,  23170,  23170,  23170,  23170,  23170,  23170,
  32138,  27245,  18204,   6392,  -6393, -18205, -27246, -32139,
  30273,  12539, -12540, -30274, -30274, -12540,  12539,  30273,
  27245,  -6393, -32139, -18205,  18204,  32138,   6392, -27246,
  23170, -23171, -23171,  23170,  23170, -23171, -23171,  23170,
  18204, -32139,   6392,  27245, -27246,  -6393,  32138, -18205,
  12539, -30274,  30273, -12540, -12540,  30273, -30274,  12539,
  6392,  -18205,  27245, -32139,  32138, -27246,  18204,  -6393,
};

static const uint16_t macroblock[] = {
#if 0
  // CrMono done
  0x0001,
  0x0001,
  0x0801,
  0x0001,
  0x03ff,
  0x17ff,
  0xfe00,
  0x2113,
 // Cb done
  0x000c,
  0x0004,
  0x03ff,
  0x03f9,
  0x03fb,
  0x07fd,
  0x03fd,
  0x2001,
  0x0001,
  0xfe00,
#endif
 // Y1 done
  0x23c2,
  0x0006,
  0x0002,
  0x0401,
  0x0001,
  0xfe00,
#if 0
 // Y2 done
  0x2114,
  0x0011,
  0x03fa,
  0x0bff,
  0x0002,
  0x2401,
  0xfe00,
  0x23c1,
 // Y3 done
  0x0005,
  0x03fe,
  0x07ff,
  0x0001,
  0x0001,
  0xfe00,
 // Y4 done
  0x239c,
  0x0001,
  0x03ff,
  0x07ff,
  0x0006,
  0x0002,
  0x1801,
  0x07ff,
  0x0001,
  0xfe00,
#endif
};

int main() {
  unsigned i;

  mdec_reset();

  mdec_set_quant_table(quant_table, false);

  mdec_set_idct_table(idct_table);

  bios_printf("Decode block\n");

  mdec_decode(macroblock,
  	      ARRAY_SIZE(macroblock),
  	      MDEC_DEPTH_8BPP,
  	      true,
  	      false);

  for (i = 0;; i++) {
    bios_printf("%02d: 0x%08x\n", i, mdec_read_data());
  }

  bios_printf("Done!\n");
}
